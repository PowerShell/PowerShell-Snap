name: powershell-preview

icon: assets/icon.png

adopt-info: powershell-preview
base: core18
summary: PowerShell for every system!
description: |
  PowerShell is an automation and configuration management platform.
  It consists of a cross-platform (Windows, Linux, and macOS)
  command-line shell and associated scripting language.

  See https://docs.microsoft.com/en-us/powershell/scripting/powershell-core-support for support details.

confinement: classic

apps:
  powershell-preview:
    command: bin/powershell-wrapper

parts:
    # A wrapper script
  launchers:
      plugin: dump
      source: .
      organize:
          launcher/powershell-wrapper: bin/powershell-wrapper
      filesets:
          wrapper: [bin/powershell-wrapper]
      stage: [$wrapper]
      prime: [$wrapper]
  powershell-preview:
    after: [launchers]
    plugin: nil
    override-pull: |
      snapcraftctl pull
      file="./version.txt"
      if [ -f "$file" ]
      then
        version=$(cat $file)
      else
        version=$(curl -s 'https://raw.githubusercontent.com/PowerShell/PowerShell/master/tools/metadata.json' | jq .PreviewReleaseTag | sed 's/"//g' | sed 's/v//')
      fi
      snapcraftctl set-version "$version"
      snapcraftctl set-grade "devel"
    override-build: |
      file="./version.txt"
      if [ -f "$file" ]
      then
        echo "using version file"
        version=$(cat $file)
      else
        echo "getting latest version from GitHub"
        version=$(curl -s 'https://raw.githubusercontent.com/PowerShell/PowerShell/master/tools/metadata.json' | jq .PreviewReleaseTag | sed 's/"//g' | sed 's/v//')
        echo "Writing version to file"
        echo $version > $file
      fi
      echo "getting powershell $version"
      curl -L -o powershell.tar.gz https://github.com/PowerShell/PowerShell/releases/download/v$version/powershell-$version-linux-x64.tar.gz
      echo "getting Third Party Notice Header"
      curl -L -o thirdPartyNoticeHeader.txt https://raw.githubusercontent.com/PowerShell/PowerShell-Snap/master/assets/thirdPartyNoticeHeader.txt
      mkdir -p $SNAPCRAFT_PART_INSTALL/opt/powershell
      tar zxf powershell.tar.gz -C $SNAPCRAFT_PART_INSTALL/opt/powershell
      chmod +x $SNAPCRAFT_PART_INSTALL/opt/powershell/pwsh
      echo "fixing symlinks"
      find $SNAPCRAFT_PART_INSTALL -type l -ls
      rm $SNAPCRAFT_PART_INSTALL/opt/powershell/libcrypto.so.1.0.0
      rm $SNAPCRAFT_PART_INSTALL/opt/powershell/libssl.so.1.0.0
      echo "removed old symlinks"
      ln -sfn ../../lib/x86_64-linux-gnu/libcrypto.so.1.0.0 $SNAPCRAFT_PART_INSTALL/opt/powershell/libcrypto.so.1.0.0
      ln -sfn ../../lib/x86_64-linux-gnu/libssl.so.1.0.0 $SNAPCRAFT_PART_INSTALL/opt/powershell/libssl.so.1.0.0
      echo "added new symlinks"
      find $SNAPCRAFT_PART_INSTALL -type l -ls
      echo "fixed symlinks"
      thirdPartyNoticeFile="$SNAPCRAFT_PART_INSTALL/thirdPartyNotices.txt"
      echo "building third party notices file - $thirdPartyNoticeFile"
      cat thirdPartyNoticeHeader.txt > $thirdPartyNoticeFile
      find $SNAPCRAFT_PART_INSTALL -type f -name 'copyright' -print | while read filename; do
        libname=$(dirname $filename | sed 's,^\(.*/\)\?\([^/]*\),\2,')
        echo ''
        echo '---------------------------------------------'
        echo "Package - $libname"
        echo '---------------------------------------------'
        cat "$filename"
      done >> $thirdPartyNoticeFile
      echo "Done building third party notices file - $thirdPartyNoticeFile"
    stage-packages:
      - libicu60
      - liblttng-ust0
      - libssl1.0.0
      - zlib1g
      - libasn1-8-heimdal
      - libaudit1
      - libcap-ng0
      - libcom-err2
      - libcurl4
      - libffi6
      - libgcc1
      - libgmp10
      - libgnutls30
      - libgssapi-krb5-2
      - libgssapi3-heimdal
      - libhcrypto4-heimdal
      - libheimbase1-heimdal
      - libheimntlm0-heimdal
      - libhogweed4
      - libhx509-5-heimdal
      - libidn2-0
      - libk5crypto3
      - libkeyutils1
      - libkrb5-26-heimdal
      - libkrb5-3
      - libkrb5support0
      - libldap-2.4-2
      - libnettle6
      - libnghttp2-14
      - libp11-kit0
      - libpam0g
      - libpsl5
      - libroken18-heimdal
      - librtmp1
      - libsasl2-2
      - libsqlite3-0
      - libssl1.1
      - libstdc++6
      - libtasn1-6
      - libunistring2
      - libwind0-heimdal
      - libdb5.3
    build-packages:
      - curl
      - jq
